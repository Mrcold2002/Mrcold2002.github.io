<!DOCTYPE html><html class="appearance-auto" lang="en"><head><meta charset="UTF-8"><title>操作系统试验--在linux环境下复现操作系统</title><meta name="description" content="菜"><meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, initial-scale=1"><!-- Google Analytics --><!-- End Google Analytics -->
<!-- Baidu Analytics --><!-- End Baidu Analytics --><link rel="icon" href="/images/favicon.ico"><link rel="stylesheet" href="/style/common/bulma.css"><link rel="stylesheet" href="/style/base.css"><link rel="stylesheet" href="/style/common/helper.css"><script src="/js/common.js"></script><link rel="stylesheet" href="/style/post.css"><link rel="stylesheet" href="/style/themes/highlight-theme-light.css"><link rel="stylesheet" href="/style/common/jquery.fancybox.min.css"><script src="/js/highlight.pack.js"></script><meta name="description" content="
本次操作系统实验根据`Orange's 一个操作系统的实现`一书进行操作。在此记录试验的过程及心得

第一章&amp;amp;第二章 Hello，OS world这两章通过在windows使用虚拟机运行Ubuntu操作系统，在Ubuntu上使用bochs虚拟机来完成操作系统。
1 使用vm运行Ubuntu我这里虚拟机运行的是Ubuntu20.04，安装虚拟机时主要遇到的问题有：

虚拟机连不上网，但在瞎搞之后能连上了，选择的时NAT连接
VM Tools 自动安装不上，会报错。VMtools可以实现Windows环境和Linux环境直接的文件交换，还是有必要安装的。解决方法是手动下载VM Tools，尽管之后还会报错，但已经能实现文件互通。

2 在Ubuntu中使用bochs我这里是在官网下载的安装包，版本是2.."><meta name="generator" content="Hexo 5.4.2"><link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
</head><body class="is-flex is-flex-direction-column"><header class="header-widget is-flex-shrink-0 is-hidden-mobile"><div class="container is-fullhd is-flex is-justify-content-space-between is-align-items-center is-full-height"><section class="is-hidden-mobile is-flex-shrink-0"><h2><a href="/">Mr_cold's blog</a></h2></section><h3 class="is-hidden-mobile is-family-serif is-full-height is-flex is-align-items-center is-flex-shrink-0"><div class="is-full-height" id="postTopic"><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">操作系统试验--在linux环境下复现操作系统</p><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">Click back to the top</p></div></h3><aside class="is-flex-shrink-0"><h3 class="is-inline-block"><a href="/">Home</a></h3><h3 class="is-inline-block"><a href="/archives">Archives</a></h3></aside></div></header><header class="is-flex header-widget is-flex-shrink-0 is-align-items-center is-justify-content-center is-hidden-tablet"><h3 class="is-inline-block"><a href="/">Home</a></h3><h3 class="is-inline-block"><a href="/archives">Archives</a></h3></header><main><main class="container is-max-widescreen content section post-page pt-4 px-4"><div class="columns is-flex-desktop is-justify-content-center is-flex-direction-row-reverse"><div class="column is-3 is-hidden-mobile"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E7%AB%A0-amp-%E7%AC%AC%E4%BA%8C%E7%AB%A0-Hello%EF%BC%8COS-world"><span class="toc-text">第一章&amp;第二章 Hello，OS world</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E4%BD%BF%E7%94%A8vm%E8%BF%90%E8%A1%8CUbuntu"><span class="toc-text">1 使用vm运行Ubuntu</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%9C%A8Ubuntu%E4%B8%AD%E4%BD%BF%E7%94%A8bochs"><span class="toc-text">2 在Ubuntu中使用bochs</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E6%9C%80%E7%AE%80%E5%8D%95%E7%9A%84%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F"><span class="toc-text">3 最简单的操作系统</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E7%AB%A0-%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F"><span class="toc-text">第三章 保护模式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E5%9B%9B%E7%AB%A0-%E8%AE%A9%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E8%BF%9B%E5%85%A5%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F"><span class="toc-text">第四章 让操作系统进入保护模式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#loader%E6%A8%A1%E5%9D%97"><span class="toc-text">loader模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%A0%E8%BD%BDLoader%E5%85%A5%E5%86%85%E5%AD%98"><span class="toc-text">加载Loader入内存</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%BA%94%E7%AB%A0"><span class="toc-text">第五章</span></a></li></ol></div><div class="column is-9"><header class="my-4"><a href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F"><i class="tag post-item-tag">操作系统</i></a></header><h1 class="mt-0 mb-1 is-family-serif" id="postTitle">操作系统试验--在linux环境下复现操作系统</h1><time class="has-text-grey" datetime="2023-03-03T08:58:13.121Z">2023-03-03</time><article class="mt-2 post-content"><img src="/images/3.jpg">
本次操作系统实验根据`Orange's 一个操作系统的实现`一书进行操作。在此记录试验的过程及心得

<h2 id="第一章-amp-第二章-Hello，OS-world"><a href="#第一章-amp-第二章-Hello，OS-world" class="headerlink" title="第一章&amp;第二章 Hello，OS world"></a>第一章&amp;第二章 Hello，OS world</h2><p>这两章通过在windows使用虚拟机运行Ubuntu操作系统，在Ubuntu上使用bochs虚拟机来完成操作系统。</p>
<h3 id="1-使用vm运行Ubuntu"><a href="#1-使用vm运行Ubuntu" class="headerlink" title="1 使用vm运行Ubuntu"></a>1 使用vm运行Ubuntu</h3><p>我这里虚拟机运行的是Ubuntu20.04，安装虚拟机时主要遇到的问题有：</p>
<ol>
<li>虚拟机连不上网，但在瞎搞之后能连上了，选择的时NAT连接</li>
<li>VM Tools 自动安装不上，会报错。VMtools可以实现Windows环境和Linux环境直接的文件交换，还是有必要安装的。解决方法是手动下载VM Tools，尽管之后还会报错，但已经能实现文件互通。</li>
</ol>
<h3 id="2-在Ubuntu中使用bochs"><a href="#2-在Ubuntu中使用bochs" class="headerlink" title="2 在Ubuntu中使用bochs"></a>2 在Ubuntu中使用bochs</h3><p>我这里是在<a target="_blank" rel="noopener" href="https://bochs.sourceforge.io/">官网</a>下载的安装包，版本是2.6.11.<br>下载完后根据书上进行安装，安装时主要命令：</p>
<pre><code class="cmd">tar vxzf bochs-2.6.11.tar.gz
cd bochs-2.6.11
./configure --enable-debugger --enable-disasm
make
sudo make install
</code></pre>
<p>但在<code>make</code>过程中会出现问题，当时在网上搜索解决掉了，现在已经忘了有什么了（因为后来才写得这篇）。<br>安装完后bochsrc文档中即用bochs模拟出的虚拟机的所有状态。同时我们可以利用bochs创建虚拟磁盘。</p>
<h3 id="3-最简单的操作系统"><a href="#3-最简单的操作系统" class="headerlink" title="3 最简单的操作系统"></a>3 最简单的操作系统</h3><p>我们首先创建一个虚拟软盘(硬盘应该也可以，书中为软盘，毕竟是09年老书)。命令<code>bximage</code><br>随后依据提示创建一个1.44MB的软盘，同时将bochsrc中<code>ata0-master: type=disk, path=&quot;a.img&quot;, mode=flat</code>中的path改为你创建磁盘的名字，这将是虚拟机的磁盘。</p>
<p>随后实现书中的boot.asm(可以直接从书附带磁盘复制出来，磁盘从学校云图书馆即可下载)：通过<code>basm boot.asm -o boot.bin</code>将asm文件转为bin文件(asm文件即汇编文件，bin文件即二进制文件)</p>
<pre><code class="asm"> org 07c00h   ; 告诉编译器程序加载到7c00处
 mov ax, cs
 mov ds, ax
 mov es, ax
 call DispStr   ; 调用显示字符串例程
 jmp $   ; 无限循环
DispStr:
 mov ax, BootMessage
 mov bp, ax   ; ES:BP = 串地址
 mov cx, 16   ; CX = 串长度
 mov ax, 01301h  ; AH = 13,  AL = 01h
 mov bx, 000ch  ; 页号为0(BH = 0) 黑底红字(BL = 0Ch,高亮)
 mov dl, 0
 int 10h   ; 10h 号中断
 ret
BootMessage:  db &quot;Hello, OS world!&quot;
times  510-($-$$) db 0 ; 填充剩下的空间，使生成的二进制代码恰好为512字节
dw  0xaa55    ; 结束标志
</code></pre>
<p>这里的boot文件即是引导扇区，其作用是将loader模块调入内存，且大小固定为512B，默认在磁盘的第一个扇区。</p>
<p>将生成的bin文件放入bochs虚拟机的文件夹。使用命令<code>dd if=boot.bin of=a.img bs=512 count=1 conv=notrunc</code>将bin文件写入软盘的第一个扇区，这里<code>conv=notrunc</code>不能删去，否则软盘会被截断(变为bin文件的大小)</p>
<p>随后即可运行bochs虚拟机，使用指令<code>bochs -f bochsrc</code>，默认选线是6：debugger，直接continue掉即可看到结果。</p>
<p>结果：视窗第一行显示<code>Hello, OS world!</code></p>
<h2 id="第三章-保护模式"><a href="#第三章-保护模式" class="headerlink" title="第三章 保护模式"></a>第三章 保护模式</h2><p>纯纯的概念，先小跳一下</p>
<h2 id="第四章-让操作系统进入保护模式"><a href="#第四章-让操作系统进入保护模式" class="headerlink" title="第四章 让操作系统进入保护模式"></a>第四章 让操作系统进入保护模式</h2><p>概念：FAT12，一种文件系统，详见书</p>
<h3 id="loader模块"><a href="#loader模块" class="headerlink" title="loader模块"></a>loader模块</h3><p>一个操作系统从开机到运行，大致经历</p>
<pre><code class="mermaid">graph LR

A[引导]--&gt;B[加载内核到内存];
B--&gt;C[跳入保护模式];
C--&gt;D[开始执行内核]
</code></pre>
<p>因此在执行内核前，还需要几步，仅靠一个512B的引导扇区是无法加载内核到内存的，因此我们将这一步工作交给一个称为Loader的模块去实现，该模块没有内存限制。</p>
<p>一个简单的loader模块为</p>
<pre><code class="asm">org 0100h

 mov ax, 0B800h
 mov gs, ax
 mov ah, 0Fh    ; 0000: 黑底    1111: 白字
 mov al, &#39;L&#39;
 mov [gs:((80 * 0 + 39) * 2)], ax ; 屏幕第 0 行, 第 39 列。

 jmp $    ; 到此停住
</code></pre>
<p>随后通过<code>nasm loader.asm -o loader.bin</code>转为二进制文件，准备放入磁盘。</p>
<h3 id="加载Loader入内存"><a href="#加载Loader入内存" class="headerlink" title="加载Loader入内存"></a>加载Loader入内存</h3><p>这里boot首先要做出改变，首先引导扇区需要BPB头信息才能被识别，其次我们要在boot的代码里实现寻找loader模块，这里代码见书附磁盘。</p>
<p>随后我们就要将loader模块放入磁盘，让boot程序找到它并执行。</p>
<p>这里书上给出命令集合为</p>
<pre><code class="asm">nasm boot.asm -o boot.bin
nasm loader.asm -o loader.bin
dd if=boot.bin of=a.img bs=512 count=1 conv=notrunc
sudo mount -o loop a.img /mnt/floppy/
sudo cp loader.bin /mnt/floppy/ -v
sudo umount /mnt/floppy/
</code></pre>
<p>但是我的<code>mnt</code>目录下没有floppy文件夹，我替换为<code>/mnt/</code>后，运行bochs虚拟机得不到想要的结果。<br>于是使用<code>dd if=loader.bin of=a.img bs=512 count=2 conv=notrunc</code>代替上述指令后三句，这样可以得到想要的结果。</p>
<p>具体的asm文件以书符磁盘为准，这样就可以从引导扇区到loader，再将loader程序导入内存。具体的汇编代码细节在此不多赘述。</p>
<h2 id="第五章"><a href="#第五章" class="headerlink" title="第五章"></a>第五章</h2></article><section class="jump-container is-flex is-justify-content-space-between my-6"><!-- em is empty placeholder--><em></em><a class="button is-default" href="/2023/02/28/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%A4%8D%E4%B9%A0/" title="数据库系统复习"><span class="has-text-weight-semibold">Next: 数据库系统复习</span><i class="iconfont icon-next ml-2 has-text-grey"></i></a></section><article class="mt-6 comment-container"><script async repo="Haojen/Claudia-theme-blog" src="https://utteranc.es/client.js" issue-term="pathname" theme="preferred-color-scheme"></script></article></div></div></main></main><footer class="is-flex is-flex-direction-column is-align-items-center is-flex-shrink-0 is-family-serif"><section class="sns-container"><!-- Github--><a title="github" target="_blank" rel="noopener nofollow" href="//github.com/Mrcold2002"><i class="iconfont icon-github"></i></a><!-- Ins--><!-- RSS--><!-- 知乎--><!-- 领英--><!-- 脸书--></section><p><span>Copyright ©</span><span> Mr_cold 2023</span></p><div class="is-flex is-justify-content-center is-flex-wrap-wrap"><p>Powered by Hexo &verbar;&nbsp;</p><p class="is-flex is-justify-content-center"><a title="Hexo theme author" target="_blank" rel="noopener" href="//github.com/haojen">Theme by Haojen&nbsp;</a></p><div style="margin-top: 2px"><a class="github-button" title="github-button" target="_blank" rel="noopener" href="https://github.com/haojen/hexo-theme-Claudia" data-color-scheme="no-preference: light; light: light; dark: dark;" data-show-count="true"></a></div></div><div><span></span></div></footer><script async defer src="https://buttons.github.io/buttons.js"></script><script src="/js/jquery-3.6.1.min.js"></script><script src="/js/jquery-fancybox.min.js"></script><script src="/js/img_zoom.js"></script><script src="/js/post.js"></script></body></html>